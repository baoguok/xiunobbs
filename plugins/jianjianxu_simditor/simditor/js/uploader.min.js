(function(d,g){"function"===typeof define&&define.amd?define("simple-uploader",["jquery","simple-module"],function(k,l){return d.uploader=g(k,l)}):"object"===typeof exports?module.exports=g(require("jquery"),require("simple-module")):(d.simple=d.simple||{},d.simple.uploader=g(jQuery,SimpleModule))})(this,function(d,g){var k,l=function(d,b){function a(){this.constructor=d}for(var c in b)m.call(b,c)&&(d[c]=b[c]);a.prototype=b.prototype;d.prototype=new a;d.__super__=b.prototype;return d},m={}.hasOwnProperty;k=function(g){function b(){return b.__super__.constructor.apply(this,arguments)}l(b,g);b.count=0;b.prototype.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3};b.prototype._init=function(){this.files=[];this.queue=[];this.id=++b.count;this.on("uploadcomplete",function(a){return function(c,f){a.files.splice(d.inArray(f,a.files),1);if(0<a.queue.length&&a.files.length<a.opts.connectionCount)return a.upload(a.queue.shift());if(0===a.files.length)return a.uploading=!1}}(this));return d(window).on("beforeunload.uploader-"+this.id,function(a){return function(c){if(a.uploading)return c.originalEvent.returnValue=a._t("leaveConfirm"),a._t("leaveConfirm")}}(this))};b.prototype.generateId=function(){var a;a=0;return function(){return a+=1}}();b.prototype.upload=function(a,c){var f,e,b;null==c&&(c={});if(null!=a){if(d.isArray(a)||a instanceof FileList)for(e=0,b=a.length;e<b;e++)f=a[e],this.upload(f,c);else if(d(a).is("input:file")){if(f=d(a).attr("name"))c.fileKey=f;this.upload(d.makeArray(d(a)[0].files),c)}else a.id&&a.obj||(a=this.getFile(a));if(a&&a.obj)if(d.extend(a,c),this.files.length>=this.opts.connectionCount)this.queue.push(a);else if(!1!==this.triggerHandler("beforeupload",[a]))return this.files.push(a),this._xhrUpload(a),this.uploading=!0}};b.prototype.getFile=function(a){var c,d,b;if(a instanceof window.File||a instanceof window.Blob)c=null!=(d=a.fileName)?d:a.name;else return null;return{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:c,size:null!=(b=a.fileSize)?b:a.size,ext:c?c.split(".").pop().toLowerCase():"",obj:a}};b.prototype._xhrUpload=function(a){var c,b,e,h;c=new FormData;c.append(a.fileKey,a.obj);c.append("original_filename",a.name);if(a.params)for(b in e=a.params,e)h=e[b],c.append(b,h);return a.xhr=d.ajax({url:a.url,data:c,processData:!1,contentType:!1,type:"POST",headers:{"X-File-Name":encodeURIComponent(a.name)},xhr:function(){var a;if(a=d.ajaxSettings.xhr())a.upload.onprogress=function(a){return function(c){return a.progress(c)}}(this);return a},progress:function(c){return function(b){if(b.lengthComputable)return c.trigger("uploadprogress",[a,b.loaded,b.total])}}(this),error:function(c){return function(b,d,e){return c.trigger("uploaderror",[a,b,d])}}(this),success:function(c){return function(b){c.trigger("uploadprogress",[a,a.size,a.size]);c.trigger("uploadsuccess",[a,b]);return d(document).trigger("uploadsuccess",[a,b,c])}}(this),complete:function(c){return function(b,d){return c.trigger("uploadcomplete",[a,b.responseText])}}(this)})};b.prototype.cancel=function(a){var c,b,d,h;if(!a.id)for(h=this.files,b=0,d=h.length;b<d;b++)if(c=h[b],c.id===1*a){a=c;break}this.trigger("uploadcancel",[a]);a.xhr&&a.xhr.abort();return a.xhr=null};b.prototype.readImageFile=function(a,c){var b,e;if(d.isFunction(c))return e=new Image,e.onload=function(){return c(e)},e.onerror=function(){return c()},window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(a.type)?(b=new FileReader,b.onload=function(a){return e.src=a.target.result},b.readAsDataURL(a)):c()};b.prototype.destroy=function(){var a,b,f,e;this.queue.length=0;e=this.files;b=0;for(f=e.length;b<f;b++)a=e[b],this.cancel(a);d(window).off(".uploader-"+this.id);return d(document).off(".uploader-"+this.id)};b.i18n={"zh-CN":{leaveConfirm:"\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6\uff0c\u5982\u679c\u79bb\u5f00\u4e0a\u4f20\u4f1a\u81ea\u52a8\u53d6\u6d88"}};b.locale="zh-CN";return b}(g);return function(d){return new k(d)}});